const express = require('express');
const cors = require('cors');
const { MongoClient } = require("mongodb");
const openAI = require('openai');
const dotenv = require('dotenv');

dotenv.config();
openai_apiKey = process.env.OPENAI_KEY;

const openai = new openAI.OpenAI({
  apiKey: openai_apiKey,
});

const app = express();
app.use(express.json());
app.use(cors());

// Replace with your MongoDB connection string
const uri = process.env.MONGO_URI;

const client = new MongoClient(uri);

const defaultIndex = {
    $search: {
      index: 'default', // Use the name of your search index if different
      text: {
        query: "",
        path: ['name', 'description'], // Search in both name and description
        fuzzy: {
            maxEdits: 2
        }
      }
    }
  }


 const project =   {
    $project: {
      _id: 0,
      name: 1,
      description: 1,
      score: { $meta: "searchScore" } // Include search score in the results
    }
  }



// Search endpoint
app.get('/search', async (req, res) => {
  const query = req.query.q;
  try {

    // connection to DB
    await client.connect();

    //get collection instance
    const productColl = client.db("test").collection("products");
    
    //look for results without Atlas Search
    const findResults = await productColl.find({ name: new RegExp(query) }).toArray();


    // look for results with Atlas Search
    defaultIndex.$search.text.query = query;
    const searchResults = await productColl.aggregate([ defaultIndex, project ]).toArray();

    res.json({ findResults, searchResults });
    
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

// recommendations endpoint
app.get('/also-recommend', async (req, res) => {
  const vector = req.query.q;
  try {
    const queryVector = [
      0.058561474,
      0.002560881,
      -0.04577926,
      -0.019516546,
      -0.006124811,
      -0.057898693,
      0.016699726,
      0.059745014,
      0.027671127,
      0.024451902,
      -0.012332469,
      0.032902364,
      -0.01451018,
      -0.03337578,
      0.020889452,
      0.05183898,
      -0.013018921,
      -0.016107956,
      -0.034322612,
      0.018321173,
      -0.016036944,
      0.054821495,
      0.021244513,
      -0.007343855,
      0.01699561,
      -0.0018596345,
      0.019682242,
      0.025398733,
      0.069260664,
      -0.0003291716,
      -0.0047726184,
      -0.01945737,
      0.034748685,
      -0.003935265,
      0.017824087,
      0.0097523555,
      -0.054016687,
      -0.0057460787,
      0.005450194,
      0.061023235,
      0.05695186,
      0.013622526,
      0.07432621,
      -0.041755233,
      0.043009784,
      0.007823188,
      0.015172961,
      0.0061721522,
      0.026014172,
      0.01576473,
      0.030677313,
      -0.0014187666,
      0.004414598,
      0.04109245,
      0.0030416935,
      -0.0041127955,
      -0.010012734,
      -0.023990322,
      0.03806259,
      0.04426433,
      -0.022605581,
      -0.0021599573,
      0.019350851,
      0.008462299,
      -0.004240026,
      -0.010876717,
      -0.0018463198,
      0.03155313,
      -0.047507226,
      -0.04516382,
      0.03794424,
      -0.031411108,
      -0.061259944,
      -0.031174399,
      -0.011385638,
      0.041376498,
      -0.019102309,
      -0.0091783395,
      0.038772713,
      0.034654003,
      -0.0028390125,
      0.021741599,
      -0.034109574,
      0.021398373,
      -0.01451018,
      -0.018214654,
      -0.043341175,
      -0.004893931,
      -0.064431824,
      -0.039080434,
      0.06376904,
      -0.025564428,
      0.019528382,
      -0.014616698,
      -0.021504892,
      0.04563724,
      0.0010888552,
      -0.0035239854,
      -0.01617897,
      0.030748324,
      -0.0030002696,
      -0.010060076,
      -0.016900927,
      -0.006021251,
      -0.015823908,
      -0.022084825,
      0.01561087,
      0.016983775,
      -0.025209365,
      0.009758273,
      -0.092789404,
      0.0069000283,
      0.0015903796,
      0.014498345,
      -0.023599753,
      -0.027860492,
      0.028239224,
      -0.027529102,
      0.027363406,
      0.0025697576,
      -0.011646017,
      0.022877796,
      -0.0046720174,
      -0.043057125,
      -0.021055147,
      -0.019599395,
      -0.016545866,
      0.010912223,
      -0.056383766,
      0.00078409415,
      -0.018037124,
      -0.012734872,
      0.07484696,
      -0.002476554,
      -0.020120151,
      -0.040571693,
      -0.01745719,
      -0.009456472,
      0.02253457,
      -0.0058022966,
      -0.007911954,
      -0.026771637,
      0.020498883,
      0.0171258,
      -0.03678437,
      0.04106878,
      0.00076412194,
      0.06817181,
      0.012018831,
      0.040216632,
      -0.019528382,
      0.011320544,
      -0.028807323,
      0.023505071,
      0.007201831,
      -0.022321533,
      0.026132526,
      0.04078473,
      0.0115217455,
      -0.0074148676,
      -0.017480861,
      -0.006426613,
      -0.03709209,
      0.023161845,
      0.028594285,
      0.00358908,
      -0.03337578,
      0.0014505741,
      -0.06779307,
      0.012036584,
      -0.027860492,
      -0.003568368,
      0.006752086,
      -0.018037124,
      -0.045258503,
      -0.022345204,
      -0.020759262,
      0.009835203,
      -0.016569536,
      -0.02625088,
      -0.0029440515,
      0.0063496833,
      -0.022215014,
      -0.0013832604,
      -0.018830094,
      0.0000015169863,
      0.03976689,
      -0.02965947,
      -0.05931894,
      0.0444537,
      -0.020806603,
      -0.021575904,
      -0.016794408,
      0.02994352,
      -0.07550974,
      -0.03458299,
      -0.01919699,
      0.016865421,
      -0.031008704,
      0.02499633,
      -0.03747082,
      0.0014261637,
      -0.0030416935,
      -0.024037663,
      0.0060893046,
      0.044666737,
      -0.076361895,
      0.029730482,
      0.030677313,
      -0.008349863,
      0.015599035,
      -0.013729044,
      -0.0077995174,
      0.0078942,
      -0.012308799,
      0.035506148,
      -0.015303151,
      -0.03429894,
      0.014735052,
      0.03176617,
      -0.03704475,
      -0.010083746,
      0.064526506,
      0.0042489027,
      0.009450553,
      0.0032961543,
      -0.02504367,
      -0.05718857,
      -0.01117852,
      -0.07087027,
      0.011160767,
      0.019753255,
      -0.05221771,
      -0.034085903,
      0.025588099,
      0.05131822,
      0.024144182,
      -0.041826244,
      -0.008817361,
      -0.0077166697,
      -0.018747248,
      -0.0054235645,
      -0.008006637,
      0.015930425,
      0.0067816745,
      0.0053969347,
      -0.020984134,
      -0.007840942,
      -0.026984673,
      0.013516008,
      0.054016687,
      0.033115402,
      0.027055686,
      -0.00740895,
      -0.0005758654,
      0.0028094242,
      -0.0028390125,
      0.0132793,
      0.037873227,
      -0.013220123,
      0.022948807,
      -0.0044826516,
      0.008438628,
      -0.014095942,
      0.00008386478,
      -0.014770558,
      -0.0019513587,
      -0.030203898,
      0.01825016,
      -0.015007266,
      -0.017255988,
      0.04698647,
      -0.039979924,
      0.017173141,
      -0.015172961,
      -0.029399091,
      -0.043057125,
      -0.030393263,
      -0.01251,
      0.015930425,
      0.0090540685,
      -0.011569087,
      0.031103387,
      0.017693898,
      0.0117407,
      0.024238864,
      0.043767247,
      0.025801135,
      -0.0280972,
      -0.015575364,
      0.025422404,
      -0.015101949,
      0.008343945,
      0.019575724,
      -0.017835923,
      -0.009580743,
      -0.09615065,
      0.046868116,
      0.02284229,
      -0.030416934,
      0.038701702,
      -0.012557342,
      0.010018651,
      0.03280768,
      -0.03460666,
      0.025990501,
      0.032547303,
      -0.02812087,
      -0.04424066,
      0.01888927,
      -0.047743935,
      0.011823548,
      -0.013018921,
      0.014806064,
      -0.011989243,
      -0.044643067,
      -0.052880492,
      -0.042110294,
      0.0047696596,
      -0.014699546,
      0.054206055,
      -0.0063260123,
      0.04443003,
      -0.01638017,
      0.0049412725,
      0.017895099,
      -0.0072432547,
      0.0010385548,
      -0.038512338,
      -0.01638017,
      0.0108234575,
      0.010367796,
      -0.025114683,
      0.020510718,
      0.04601597,
      -0.04232333,
      -0.006450284,
      -0.08071731,
      0.0012582492,
      0.030700983,
      -0.018877435,
      -0.027671127,
      -0.03332844,
      0.0037814048,
      -0.024593927,
      0.007385279,
      0.036050577,
      0.028026188,
      0.023528742,
      0.03190819,
      0.005680984,
      0.03148212,
      -0.00948606,
      -0.026156196,
      -0.021717928,
      -0.044003956,
      0.066940926,
      -0.015812071,
      -0.017279658,
      0.03858335,
      0.041281816,
      0.017232317,
      0.048312034,
      -0.002668879,
      -0.018143643,
      0.04563724,
      -0.035198428,
      0.0450218,
      -0.010793869,
      -0.02178894,
      0.046868116,
      0.024108676,
      0.016238146,
      -0.048951145,
      -0.04755457,
      -0.02847593,
      0.015208467,
      0.059460964,
      0.03058263,
      -0.036902726,
      0.0104506435,
      0.034393623,
      -0.025824806,
      0.015965931,
      0.029233396,
      0.0058289263,
      -0.027434418,
      0.017327001,
      0.0057224077,
      -0.014155118,
      -0.00479333,
      0.0052549103,
      -0.0066218968,
      -0.02181261,
      -0.0050596264,
      -0.018179148,
      0.038180947,
      0.01266386,
      0.007077559,
      -0.029162385,
      -0.030322252,
      -0.006195823,
      -0.017398013,
      -0.011758453,
      0.011302791,
      0.041920926,
      0.050466076,
      -0.04296244,
      -0.033257425,
      0.0013640278,
      0.015184796,
      -0.08564083,
      0.009645837,
      -0.02530405,
      0.0057460787,
      0.0050211614,
      -0.041021436,
      -0.015551694,
      0.024522914,
      0.013847399,
      0.045305848,
      -0.026416576,
      -0.052407075,
      -0.00063282315,
      0.015303151,
      0.03268933,
      0.023658931,
      -0.035435136,
      -0.026771637,
      -0.0148415705,
      0.0071189827,
      0.010675516,
      0.055247568,
      0.014616698,
      0.0050182026,
      -0.023777286,
      -0.039388154,
      -0.016297322,
      0.03706842,
      0.012900568,
      0.019670406,
      -0.031647816,
      -0.04357788,
      0.024806963,
      -0.02781315,
      -0.02145755,
      0.0009830765,
      0.015717389,
      -0.052312393,
      -0.010107418,
      0.010918141,
      0.0034973556,
      -0.05316454,
      -0.017327001,
      0.022215014,
      0.02781315,
      0.0072195837,
      -0.028381249,
      0.0007700396,
      0.041163463,
      0.06978142,
      0.0155398585,
      -0.0043435856,
      -0.02845226,
      -0.0025238954,
      0.030203898,
      0.02930441,
      -0.048122667,
      0.035032734,
      0.03212123,
      0.030061873,
      -0.010426973,
      0.035411466,
      0.033778183,
      0.0061484817,
      -0.017954277,
      -0.041329157,
      0.0332811,
      0.0020371652,
      -0.00505075,
      -0.004026989,
      -0.01945737,
      -0.027884163,
      0.011296873,
      0.012486329,
      0.04504547,
      0.020416036,
      0.029115042,
      0.020285847,
      -0.0035210266,
      -0.06907129,
      0.026132526,
      0.0047223177,
      -0.010350043,
      0.017551873,
      -0.016463017,
      -0.0388674,
      -0.008456381,
      -0.008361698,
      0.023221022,
      0.019220661,
      0.0012841391,
      0.027718468,
      0.019978127,
      0.018214654,
      0.03917512,
      -0.013882904,
      -0.01978876,
      0.017267823,
      -0.0030742409,
      0.034464635,
      -0.008006637,
      0.026037842,
      0.004911684,
      0.0020963422,
      -0.035127416,
      -0.0023522824,
      0.0450218,
      -0.014249802,
      -0.021907294,
      -0.03777854,
      0.018522374,
      -0.019516546,
      -0.0077817645,
      0.0041483017,
      -0.027884163,
      0.0010577873,
      -0.04416965,
      -0.04042967,
      -0.005544877,
      -0.023753613,
      0.012770378,
      -0.040903084,
      -0.008947549,
      -0.03119807,
      0.042844087,
      0.027410747,
      0.005314087,
      -0.0082788505,
      -0.004740071,
      -0.0025194571,
      0.014829735,
      0.0014993951,
      -0.011995161,
      -0.021410208,
      -0.000018804853,
      -0.004831795,
      -0.031434778,
      -0.013208288,
      0.020806603,
      0.0056898603,
      0.025398733,
      0.018202819,
      -0.028026188,
      0.039411824,
      0.0139894225,
      -0.01253367,
      -0.007811353,
      0.022641089,
      0.018747248,
      0.008438628,
      0.02130369,
      0.016143462,
      -0.0036097919,
      0.04050068,
      0.034748685,
      -0.0016687891,
      -0.008420875,
      -0.018167313,
      0.002012015,
      0.02240438,
      0.0058437204,
      -0.031056045,
      -0.028641628,
      0.016865421,
      0.019694077,
      -0.016723396,
      -0.048075326,
      -0.054016687,
      0.03129275,
      -0.0041127955,
      -0.011184437,
      -0.04606331,
      -0.009941722,
      -0.06651485,
      -0.0075746453,
      0.03330477,
      -0.013918411,
      -0.007752176,
      -0.02148122,
      0.025753794,
      -0.022061154,
      -0.020167492,
      -0.027505431,
      -0.0377312,
      0.023576083,
      -0.047933303,
      0.000048543563,
      -0.01914965,
      -0.03058263,
      -0.029612128,
      0.012450823,
      -0.02596683,
      0.025469745,
      -0.03183718,
      -0.018581552,
      -0.014557521,
      -0.007367526,
      -0.004677935,
      0.030464277,
      0.010273113,
      -0.059176914,
      -0.029777825,
      -0.010196183,
      -0.008296603,
      0.020392366,
      0.045897614,
      0.02532772,
      -0.02286596,
      -0.017445356,
      -0.0014764641,
      0.013871069,
      0.011503993,
      0.010290866,
      0.020131987,
      0.018699905,
      0.0014897789,
      -0.048998486,
      -0.024641268,
      -0.016924597,
      0.0011354571,
      0.019256169,
      0.021682423,
      -0.007734423,
      -0.029470105,
      -0.038488667,
      0.003722228,
      0.004846589,
      -0.014036764,
      -0.009693178,
      0.015989603,
      0.005544877,
      0.034843367,
      -0.012403482,
      0.015125619,
      0.036595006,
      -0.0039145527,
      0.035458807,
      0.020451542,
      -0.006201741,
      0.015243974,
      0.0015415587,
      0.021339197,
      0.014178789,
      -0.006829016,
      0.049945317,
      0.011498075,
      -0.040619034,
      0.004393886,
      -0.027363406,
      0.021197172,
      -0.022570075,
      0.009616249,
      0.0155871995,
      -0.007136736,
      0.016806245,
      0.018119972,
      -0.0022694347,
      -0.013137275,
      -0.004195643,
      0.04012195,
      0.020475212,
      0.02301982,
      -0.01110159,
      -0.004603964,
      -0.014936253,
      -0.00008428087,
      0.01453385,
      0.0037695696,
      0.009533402,
      0.035553493,
      0.016060615,
      -0.049377218,
      -0.026487587,
      -0.004935355,
      0.0022620377,
      0.008568818,
      -0.031671487,
      0.004275532,
      -0.010568997,
      0.015243974,
      0.01112526,
      0.0064384486,
      0.014711381,
      -0.017019281,
      -0.0030076667,
      0.004568458,
      -0.00648579,
      0.03183718,
      -0.0321449,
      -0.014320814,
      0.058561474,
      -0.030535288,
      -0.020782933,
      -0.053022515,
      -0.031079717,
      -0.051412903,
      -0.008669418,
      0.0005414688,
      -0.004183808,
      0.003355331,
      -0.009184257,
      -0.019836102,
      0.0018640729,
      -0.012119432,
      -0.03205022,
      0.018853765,
      -0.028902005,
      -0.010983235,
      -0.042560037,
      0.019054966,
      0.0025815929,
      -0.036950067,
      0.01117852,
      0.005506412,
      -0.020155657,
      0.0067461682,
      -0.05770933,
      -0.008793689,
      0.027292393,
      0.00802439,
      0.022061154,
      0.036074247,
      0.026747966,
      -0.018640729,
      -0.0061425637,
      -0.020297682,
      -0.02191913,
      -0.026629612,
      -0.043175478,
      -0.014948089,
      0.014214295,
      -0.047980644,
      0.005775667,
      -0.025706451,
      -0.024061333,
      0.0060715517,
      -0.02563544,
      -0.029919848,
      0.0321449,
      -0.008645748,
      0.008077649,
      -0.0020164533,
      0.00054109894,
      0.018190984,
      -0.047601912,
      -0.011545416,
      0.04450104,
      0.026321892,
      -0.017942442,
      -0.010598586,
      0.01407227,
      -0.0024440065,
      0.014782393,
      -0.006775757,
      -0.0118472185,
      -0.025114683,
      -0.009207928,
      0.018877435,
      0.011823548,
      0.042252317,
      0.011308708,
      0.010302701,
      0.0016643507,
      0.005621807,
      0.017634721,
      -0.01594226,
      0.01681808,
      -0.04532952,
      -0.007959295,
      0.054111373,
      0.0021806695,
      0.025777465,
      0.012628354,
      -0.020084646,
      -0.03089035,
      0.015196632,
      0.017386178,
      0.018830094,
      0.017693898,
      0.013066263,
      -0.04140017,
      0.01994262,
      0.00502412,
      0.0055389595,
      -0.020652743,
      -0.013113605,
      -0.03122174,
      0.03266566,
      0.010941812,
      0.03361249,
      0.0030047079,
      0.004624676,
      0.0029869548,
      0.0332811,
      0.01563454,
      -0.044927113,
      0.010077829,
      -0.02996719,
      -0.00133296,
      0.0011798397,
      -0.012249622,
      -0.006432531,
      0.042062953,
      0.036689688,
      -0.00994764,
      -0.055389594,
      0.0017028158,
      0.0115217455,
      0.0014010135,
      0.019705912,
      -0.00463947,
      -0.000029680921,
      -0.00067942496,
      -0.0058259675,
      -0.008385369,
      0.033801854,
      0.013811892,
      -0.018676234,
      -0.008675336,
      -0.023753613,
      0.014746888,
      0.040642705,
      -0.016415676,
      0.019244334,
      0.018546045,
      -0.026771637,
      -0.015350492,
      -0.008373533,
      0.028310236,
      0.0058407616,
      -0.013871069,
      0.017622886,
      -0.018486869,
      0.015208467,
      0.01971775,
      0.007266925,
      0.00833211,
      -0.06054982,
      0.0129952505,
      -0.016877256,
      0.0088055255,
      -0.07063357,
      0.023090832,
      0.021102488,
      -0.020131987,
      0.057330597,
      -0.010054158,
      -0.024333548,
      -0.017054787,
      -0.000046925445,
      0.02317368,
      -0.0039263885,
      0.00797113,
      -0.021694258,
      0.03981423,
      0.007823188,
      0.0005096612,
      0.009059986,
      0.034961723,
      -0.016924597,
      0.02840492,
      0.016261816,
      -0.027529102,
      -0.01143298,
      0.005873309,
      0.003935265,
      0.052359734,
      0.0081072375,
      0.008651665,
      0.00374294,
      0.031955533,
      0.011776206,
      0.0016613919,
      -0.035103746,
      -0.015220303,
      -0.028310236,
      0.053969346,
      0.046820775,
      0.005627725,
      0.02440456,
      -0.0062254113,
      0.017433519,
      -0.012758543,
      -0.0026910703,
      0.017090293,
      0.024688609,
      0.055152886,
      -0.0055389595,
      0.01919699,
      -0.012012914,
      -0.033588815,
      0.0048051653,
      0.008432711,
      -0.03458299,
      0.023812791,
      0.050513417,
      -0.0056366012,
      0.0034500142,
      0.039009422,
      0.007556892,
      -0.00748588,
      0.001184278,
      -0.009622167,
      0.037825886,
      0.0075450568,
      -0.015255809,
      0.008580653,
      0.0039678123,
      -0.011681523,
      -0.02568278,
      0.0010629654,
      0.0022206136,
      -0.014439167,
      0.015101949,
      -0.02899669,
      -0.015409669,
      0.017031116,
      0.061354626,
      -0.002340447,
      0.014794229,
      0.008515558,
      -0.028854664,
      0.059745014,
      0.059129573,
      -0.013800057,
      -0.0029544076,
      0.009776026,
      -0.010711022,
      0.004092084,
      0.011634181,
      0.012042502,
      -0.012285127,
      0.0071308184,
      0.023871968,
      0.009089574,
      0.017540038,
      -0.007479962,
      0.012249622,
      -0.036642347,
      -0.00026796048,
      -0.02591949,
      -0.020629073,
      0.033801854,
      0.017078457,
      0.007189995,
      -0.05041873,
      0.026156196,
      -0.002122972,
      -0.0035594914,
      0.00266592,
      -0.016711561,
      -0.025398733,
      -0.029919848,
      0.026700625,
      0.05808806,
      -0.0029203808,
      -0.010787952,
      0.044927113,
      -0.011870889,
      -0.0036600921,
      0.0013862193,
      0.005311128,
      -0.008858784,
      0.00003855746,
      0.012711202,
      -0.022605581,
      0.010983235,
      0.03796791,
      0.014758723,
      0.03249996,
      0.056762498,
      0.065662704,
      0.0071485713,
      -0.030487947,
      0.004911684,
      0.019220661,
      0.028523274,
      -0.006811263,
      -0.026700625,
      0.012959745,
      -0.003683763,
      -0.00081294286,
      -0.042536367,
      -0.030085543,
      0.03825196,
      0.036263615,
      0.05652579,
      0.009438718,
      0.022593746,
      -0.05075012,
      -0.024570255,
      0.044974457,
      0.026487587,
      -0.017528202,
      0.003778446,
      0.0315768,
      0.0342516,
      -0.024806963,
      0.023244692,
      -0.013160946,
      -0.013930246,
      0.0097050145,
      -0.039364483,
      0.030369593,
      -0.009906216,
      -0.013480501,
      -0.001497176,
      0.031150728,
      0.01888927,
      -0.0016377211,
      -0.00817825,
      0.0033257427,
      0.020368695,
      0.010178429,
      0.0030446523,
      0.018285668,
      -0.009941722,
      0.0062609175,
      0.02345773,
      0.00974052,
      -0.009077739,
      -0.02563544,
      0.00787053,
      -0.041021436,
      0.038725372,
      -0.0321449,
      -0.07243255,
      0.006420695,
      0.02530405,
      0.006811263,
      -0.008864702,
      -0.027292393,
      -0.016652385,
      -0.03247629,
      -0.006056757,
      0.0051276796,
      0.010912223,
      -0.0062609175,
      0.015977766,
      -0.00018640728,
      -0.0018551963,
      -0.018001618,
      -0.0043317503,
      0.033517804,
      -0.039388154,
      0.007805435,
      0.0018907024,
      -0.022925137,
      -0.02268843,
      0.0029129838,
      0.015847579,
      0.041139793,
      0.014983595,
      0.035198428,
      0.014368155,
      -0.0013196452,
      -0.0048406716,
      0.029777825,
      -0.027907833,
      0.0059236092,
      0.029138714,
      0.039009422,
      0.00085806526,
      -0.006450284,
      -0.019362686,
      -0.048288364,
      0.022167673,
      -0.0074326205,
      0.008710842,
      -0.026345562,
      0.06481056,
      -0.0077225873,
      -0.028973019,
      -0.024664938,
      -0.007515468,
      -0.001707254,
      -0.044974457,
      -0.004953108,
      -0.014131447,
      -0.006965123,
      -0.0010548285,
      0.0006468777,
      0.0019987004,
      0.018640729,
      -0.017184976,
      0.003302072,
      -0.0043435856,
      -0.0122969635,
      0.0112732025,
      0.0069532874,
      0.00043125177,
      0.005914733,
      -0.006213576,
      0.0004693469,
      -0.02847593,
      -0.003568368,
      -0.0019469205,
      -0.008687171,
      0.032310598,
      0.04042967,
      0.017007446,
      -0.014652205,
      -0.0021348072,
      0.042583708,
      0.015279479,
      0.017634721,
      0.035884883,
      -0.011143013,
      0.0024395683,
      0.0079060355,
      0.011959654,
      0.0015371204,
      0.020108316,
      0.005337758,
      -0.0067461682,
      -0.027907833,
      0.022321533,
      -0.011533581,
      0.00671658,
      -0.022605581,
      -0.00997131,
      -0.047933303,
      -0.0051158443,
      0.032547303,
      -0.01956389,
      0.00148682,
      0.004092084,
      -0.060644504,
      0.04050068,
      0.011119342,
      -0.0043199146,
      0.016309159,
      -0.004456022,
      -0.026345562,
      -0.03332844,
      -0.01714947,
      0.046820775,
      0.01253367,
      0.011569087,
      0.0047903713,
      0.024972659,
      -0.006580473,
      0.008468216,
      -0.022084825,
      0.0342516,
      0.06731966,
      0.023374882,
      0.053922005,
      -0.019646736,
      -0.042536367,
      0.0019202909,
      -0.0122969635,
      0.039080434,
      -0.016723396,
      0.024759622,
      -0.009929886,
      -0.0336835,
      -0.008284768,
      0.03986157,
      -0.028570615,
      0.0017619927,
      -0.010373713,
      0.004532952,
      -0.00794746,
      0.022475393,
      0.0056099715,
      0.015232138,
      -0.022309696,
      0.015705554,
      -0.00948606,
      0.05965033,
      -0.025517086,
      -0.021209007,
      -0.026061514,
      0.041849915,
      0.0006073031,
      -0.0051927743,
      0.010722857,
      0.0015104908,
      0.0046897708,
      -0.0011805794,
      0.032002877,
      0.003985565,
      -0.034843367,
      -0.014143283,
      0.004926478,
      -0.0004142384,
      0.05093949,
      -0.00010291235,
      -0.0003876088,
      0.005068503,
      -0.03955385,
      0.029115042,
      -0.014166954,
      -0.047081154,
      -0.010669598,
      -0.014462838,
      -0.018759083,
      -0.026369235,
      0.020439707,
      -0.0055951774,
      0.013859234,
      -0.004571417,
      -0.007136736,
      0.012024749,
      0.006278671,
      0.020806603,
      0.017054787,
      0.00997131,
      -0.042252317,
      0.031340096,
      0.03917512,
      -0.017599214,
      0.008545146,
      0.0015992562,
      -0.024002157,
      -0.0014742449,
      0.020487048,
      -0.0110720005,
      0.012604683,
      0.005355511,
      0.03775487,
      -0.02842859,
      -0.0074681267,
      -0.0008491887,
      0.01268753,
      0.0049560666,
      0.021753434,
      0.04532952,
      -0.0028049857,
      -0.015101949,
      0.0025727164,
      0.019824266,
      -0.0336835,
      -0.014853406,
      0.003334619,
      0.016297322,
      0.008710842,
      -0.06561536,
      -0.01904313,
      -0.0049560666,
      -0.0047519063,
      0.02471228,
      0.012936073,
      0.00032824694,
      -0.012379811,
      -0.01822649,
      -0.020984134,
      0.03394388,
      -0.023161845,
      0.011864971,
      -0.020735592,
      -0.015883084,
      0.034535646,
      -0.0077166697,
      -0.004701606,
      -0.020984134,
      -0.01917332,
      0.01453385,
      -0.000011373064,
      -0.008870619,
      -0.0031097468,
      -0.0022058196,
      0.02622721,
      -0.0016687891,
      -0.00090540684,
      0.003997401,
      -0.011083837,
      0.006829016,
      -0.0296358,
      0.000815162,
      -0.012332469,
      -0.0014165475,
      0.003009146,
      -0.0027413706,
      -0.013776386,
      -0.022345204,
      0.013871069,
      -0.014924418,
      -0.0037814048,
      0.012178609,
      0.04260738,
      0.00061617966,
      0.0051483917,
      -0.008296603,
      -0.007616069,
      -0.019386357,
      -0.0004604704,
      -0.007959295,
      0.0067935097,
      0.04360155,
      0.018427692,
      0.021339197,
      -0.0024454861,
      0.023197351,
      0.0066278144,
      -0.032239582,
      -0.007835024,
      -0.0004745249,
      0.0018448404,
      -0.03297338,
      0.00004130826,
      -0.008598406,
      -0.0045921286,
      -0.014439167,
      -0.03957752,
      0.044690408,
      0.00044308716,
      -0.0064739548,
      -0.032002877,
      -0.008071731,
      -0.009030397,
      -0.007367526,
      0.029280737,
      -0.012450823,
      -0.0067224978,
      -0.009397294,
      0.032263253,
      -0.028262895,
      0.024025828,
      0.0038346641,
      -0.014983595,
      -0.0011066083,
      -0.014391826,
      0.043175478,
      -0.015812071,
      0.00328136,
      0.010480232,
      0.0060390043,
      -0.034038562,
      0.027529102,
      0.027552772,
      0.022084825,
      0.005846679,
      -0.0014387388,
      -0.030748324,
      -0.015267644,
      -0.019031296,
      -0.009728685,
      0.020664578,
      0.028546944,
      -0.031671487,
      0.010634092,
      0.014877076,
      -0.004991573,
      0.0062964237,
      0.041116122,
      -0.0010452123,
      -0.0009697617,
      0.011906396,
      0.05657313,
      0.03276034,
      -0.0031304588,
      0.0076397397,
      0.010332289,
      0.005488659,
      -0.0043820506,
      -0.035553493,
      0.0035920388,
      -0.05685718,
      -0.005003408,
      -0.03306806,
      0.0469628,
      0.01714947,
      0.010912223,
      -0.012592847,
      0.0046838527,
      0.01253367,
      0.03238161,
      -0.0015933384,
      0.021670587,
      -0.0011953737,
      -0.005467947,
      0.022700265,
      0.004393886,
      -0.014285307,
      -0.0027842738,
      -0.030914022,
      -0.025493415,
      -0.014084106,
      0.016119791,
      -0.030038202,
      0.018037124,
      -0.018569715,
      0.0077403407,
      0.011450733,
      -0.044359017,
      0.0063378476,
      0.004544787,
      -0.030937692,
      0.0049974904,
      0.00073712243,
      -0.00035358206,
      0.0039145527,
      -0.0039766887,
      -0.03953018,
      0.00633193,
      0.037518166,
      0.037494496,
      -0.023540577,
      -0.0023759531,
      0.00710123,
      -0.014332649,
      0.018001618,
      -0.022877796,
      0.01838035,
      -0.01150991,
      -0.0042873677,
      -0.009965393,
      0.0027783562,
      -0.047057483,
      0.008136826,
      0.0026614817,
      -0.007006547,
      0.009574825,
      -0.026889991,
      -0.0056070127,
      0.021398373,
      -0.044927113,
      -0.048572414,
      -0.0010533491,
      0.035695516,
      -0.045921285,
      0.006136646,
      0.00018936612,
      -0.01563454,
      0.021137994,
      0.024357218,
      -0.019540217,
      -0.011527663,
      0.047767606,
      0.013078098,
      -0.031955533,
      -0.018048959,
      -0.047696594,
      0.010557162,
      0.013208288,
      -0.0067402506,
      -0.015409669,
      -0.010196183,
      0.017327001,
      0.02502,
      0.015326821,
      0.03209756,
      0.0061425637,
      0.020285847,
      0.032239582,
      0.018948449,
      -0.018001618,
      -0.024854304,
      0.013267465,
      -0.015622706,
      -0.01133238,
      -0.012711202,
      -0.009491977,
      0.0055922186,
      0.012474494,
      0.021433879,
      0.01868807,
      -0.012427152,
      -0.022155838,
      -0.011734783,
      0.008450463,
      0.0026703584,
      0.0082788505,
      0.012853226,
      0.03186085,
      0.034796026,
      -0.03616893,
      0.032926034,
      -0.032878693,
      0.028830994,
      -0.018924778,
      0.075131014,
      0.035293113,
      -0.03238161,
      0.008184168,
      0.0015008745,
      0.020593567,
      0.002053439,
      0.03552982,
      0.018936614,
      -0.02238071,
      0.010716939,
      -0.041731562,
      -0.0129952505,
      0.023434058,
      0.0021288896,
      -0.047199506,
      -0.009367705,
      0.047175836,
      0.0013129878,
      0.015184796,
      0.030771997,
      0.007367526,
      -0.030795667,
      -0.012178609,
      0.020238506,
      0.020356858,
      -0.018498704,
      0.0040181126,
      -0.016119791,
      0.006278671,
      -0.0120484205,
      -0.03976689,
      0.017658392,
      -0.02297248,
      0.007521386,
      -0.0007737382,
      -0.029162385,
      0.002850848,
      0.0016318035,
      -0.034725014,
      0.006278671,
      -0.003260648,
      0.027623784,
      -0.021078818,
      -0.023647096,
      -0.03863069,
      -0.005201651,
      0.047909632,
      0.02130369,
      -0.012143103,
      -0.017315166,
      -0.0025756753
    ]; // replace with your query vector
    const collectionName = "catalog";
    const collection = client.db("ecommerce").collection(collectionName);
    const pipeline = [
      {
        $vectorSearch: {
          index: "vector_index", 
          //path: "vector", 
          path: "description_embedding", 
          queryVector:queryVector, 
          numCandidates: 3, 
          limit: 2
        }
      }, {
        '$project': {
          _id: 0, 
          title: 1, 
          description: 1, 
          score: {
            $meta: "vectorSearchScore"
          }
        }
      }
    ];

    const result = await collection.aggregate(pipeline).toArray();

    res.json(result);

  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});


app.get('/vectorize', async (req, res) => {
  const collectionName = "catalog";
  const collection = client.db("ecommerce").collection(collectionName);

  const cursor = collection.find({});
  while (await cursor.hasNext()) {
      const doc = await cursor.next();
      const vector = await createVector(doc.description); // replace with your field
      await collection.updateOne({ _id: doc._id }, { $set: { description_embedding: vector } });
  }

  res.send('Vectorization completed');
});

async function createVector(data) {
  const response = await openai.embeddings.create({
      model: "text-embedding-3-small",
      input: data,
      encoding_format: "float"
  });

  return response.data[0].embedding;
}


const port = process.env.PORT;
console.log(port);

app.listen(port, () => console.log('Server running on port ' + port));

