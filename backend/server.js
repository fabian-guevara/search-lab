const express = require('express');
const cors = require('cors');
const { MongoClient } = require("mongodb");
const openAI = require('openai');
const dotenv = require('dotenv');

dotenv.config();
openai_apiKey = process.env.OPENAI_KEY;

const openai = new openAI.OpenAI({
  apiKey: openai_apiKey,
});

const app = express();
app.use(express.json());
app.use(cors());

// Replace with your MongoDB connection string
const uri = process.env.MONGO_URI;

const client = new MongoClient(uri);

const defaultIndex = {
    $search: {
      index: 'default', // Use the name of your search index if different
      text: {
        query: "",
        path: ['name', 'description'], // Search in both name and description
        fuzzy: {
            maxEdits: 2
        }
      }
    }
  }


 const project =   {
    $project: {
      _id: 0,
      name: 1,
      description: 1,
      score: { $meta: "searchScore" } // Include search score in the results
    }
  }



// Search endpoint
app.get('/search', async (req, res) => {
  const query = req.query.q;
  try {

    // connection to DB
    await client.connect();

    //get collection instance
    const productColl = client.db("test").collection("products");
    
    //look for results without Atlas Search
    const findResults = await productColl.find({ name: new RegExp(query) }).toArray();


    // look for results with Atlas Search
    defaultIndex.$search.text.query = query;
    const searchResults = await productColl.aggregate([ defaultIndex, project ]).toArray();

    res.json({ findResults, searchResults });
    
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

// recommendations endpoint
app.get('/also-recommend', async (req, res) => {
  const vector = req.query.q;
  try {
    const queryVector = [
      0.058561474,
      0.002560881,
      -0.04577926,
      -0.019516546,
      -0.006124811,
      -0.057898693,
      0.016699726,
      0.059745014,
      0.027671127,
      0.024451902,
      -0.012332469,
      0.032902364,
      -0.01451018,
      -0.03337578,
      0.020889452,
      0.05183898,
      -0.013018921,
      -0.016107956,
      -0.034322612,
      0.018321173,
      -0.016036944,
      0.054821495,
      0.021244513,
      -0.007343855,
      0.01699561,
      -0.0018596345,
      0.019682242,
      0.025398733,
      0.069260664,
      -0.0003291716,
      -0.0047726184,
      -0.01945737,
      0.034748685,
      -0.003935265,
      0.017824087,
      0.0097523555,
      -0.054016687,
      -0.0057460787,
      0.005450194,
      0.061023235,
      0.05695186,
      0.013622526,
      0.07432621,
      -0.041755233,
      0.043009784,
      0.007823188,
      0.015172961,
      0.0061721522,
      0.026014172,
      0.01576473,
      0.030677313,
      -0.0014187666,
      0.004414598,
      0.04109245,
      0.0030416935,
      -0.0041127955,
      -0.010012734,
      -0.023990322,
      0.03806259,
      0.04426433,
      -0.022605581,
      -0.0021599573,
      0.019350851,
      0.008462299,
      -0.004240026,
      -0.010876717,
      -0.0018463198,
      0.03155313,
      -0.047507226,
      -0.04516382,
      0.03794424,
      -0.031411108,
      -0.061259944,
      -0.031174399,
      -0.011385638,
      0.041376498,
      -0.019102309,
      -0.0091783395,
      0.038772713,
      0.034654003,
      -0.0028390125,
      0.021741599,
      -0.034109574,
      0.021398373,
      -0.01451018,
      -0.018214654,
      -0.043341175,
      -0.004893931,
      -0.064431824,
      -0.039080434,
      0.06376904,
      -0.025564428,
      0.019528382,
      -0.014616698,
      -0.021504892,
      0.04563724,
      0.0010888552,
      -0.0035239854,
      -0.01617897,
      0.030748324,
      -0.0030002696,
      -0.010060076,
      -0.016900927,
      -0.006021251,
      -0.015823908,
      -0.022084825,
      0.01561087,
      0.016983775,
      -0.025209365,
      0.009758273,
      -0.092789404,
      0.0069000283,
      0.0015903796,
      0.014498345,
      -0.023599753,
      -0.027860492,
      0.028239224,
      -0.027529102,
      0.027363406,
      0.0025697576,
      -0.011646017,
      0.022877796,
      -0.0046720174,
      -0.043057125,
      -0.021055147,
      -0.019599395,
      -0.016545866,
      0.010912223,
      -0.056383766,
      0.00078409415,
      -0.018037124,
      -0.012734872,
      0.07484696,
      -0.002476554,
      -0.020120151,
      -0.040571693,
      -0.01745719,
      -0.009456472,
      0.02253457,
      -0.0058022966,
      -0.007911954,
      -0.026771637,
      0.020498883,
      0.0171258,
      -0.03678437,
      0.04106878,
      0.00076412194,
      0.06817181,
      0.012018831,
      0.040216632,
      -0.019528382,
      0.011320544,
      -0.028807323,
      0.023505071,
      0.007201831,
      -0.022321533,
      0.026132526,
      0.04078473,
      0.0115217455,
      -0.0074148676,
      -0.017480861,
      -0.006426613,
      -0.03709209,
      0.023161845,
      0.028594285,
      0.00358908,
      -0.03337578,
      0.0014505741,
      -0.06779307,
      0.012036584,
      -0.027860492,
      -0.003568368,
      0.006752086,
      -0.018037124,
      -0.045258503,
      -0.022345204,
      -0.020759262,
      0.009835203,
      -0.016569536,
      -0.02625088,
      -0.0029440515,
      0.0063496833,
      -0.022215014,
      -0.0013832604,
      -0.018830094,
      0.0000015169863,
      0.03976689,
      -0.02965947,
      -0.05931894,
      0.0444537,
      -0.020806603,
      -0.021575904,
      -0.016794408,
      0.02994352,
      -0.07550974,
      -0.03458299,
      -0.01919699,
      0.016865421,
      -0.031008704,
      0.02499633,
      -0.03747082,
      0.0014261637,
      -0.0030416935,
      -0.024037663,
      0.0060893046,
      0.044666737,
      -0.076361895,
      0.029730482,
      0.030677313,
      -0.008349863,
      0.015599035,
      -0.013729044,
      -0.0077995174,
      0.0078942,
      -0.012308799,
      0.035506148,
      -0.015303151,
      -0.03429894,
      0.014735052,
      0.03176617,
      -0.03704475,
      -0.010083746,
      0.064526506,
      0.0042489027,
      0.009450553,
      0.0032961543,
      -0.02504367,
      -0.05718857,
      -0.01117852,
      -0.07087027,
      0.011160767,
      0.019753255,
      -0.05221771,
      -0.034085903,
      0.025588099,
      0.05131822,
      0.024144182,
      -0.041826244,
      -0.008817361,
      -0.0077166697,
      -0.018747248,
      -0.0054235645,
      -0.008006637,
      0.015930425,
      0.0067816745,
      0.0053969347,
      -0.020984134,
      -0.007840942,
      -0.026984673,
      0.013516008,
      0.054016687,
      0.033115402,
      0.027055686,
      -0.00740895,
      -0.0005758654,
      0.0028094242,
      -0.0028390125,
      0.0132793,
      0.037873227,
      -0.013220123,
      0.022948807,
      -0.0044826516,
      0.008438628,
      -0.014095942,
      0.00008386478,
      -0.014770558,
      -0.0019513587,
      -0.030203898,
      0.01825016,
      -0.015007266,
      -0.017255988,
      0.04698647,
      -0.039979924,
      0.017173141,
      -0.015172961,
      -0.029399091,
      -0.043057125,
      -0.030393263,
      -0.01251,
      0.015930425,
      0.0090540685,
      -0.011569087,
      0.031103387,
      0.017693898,
      0.0117407,
      0.024238864,
      0.043767247,
      0.025801135,
      -0.0280972,
      -0.015575364,
      0.025422404,
      -0.015101949,
      0.008343945,
      0.019575724,
      -0.017835923,
      -0.009580743,
      -0.09615065,
      0.046868116,
      0.02284229,
      -0.030416934,
      0.038701702,
      -0.012557342,
      0.010018651,
      0.03280768,
      -0.03460666,
      0.025990501,
      0.032547303,
      -0.02812087,
      -0.04424066,
      0.01888927,
      -0.047743935,
      0.011823548,
      -0.013018921,
      0.014806064,
      -0.011989243,
      -0.044643067,
      -0.052880492,
      -0.042110294,
      0.0047696596,
      -0.014699546,
      0.054206055,
      -0.0063260123,
      0.04443003,
      -0.01638017,
      0.0049412725,
      0.017895099,
      -0.0072432547,
      0.0010385548,
      -0.038512338,
      -0.01638017,
      0.0108234575,
      0.010367796,
      -0.025114683,
      0.020510718,
      0.04601597,
      -0.04232333,
      -0.006450284,
      -0.08071731,
      0.0012582492,
      0.030700983,
      -0.018877435,
      -0.027671127,
      -0.03332844,
      0.0037814048,
      -0.024593927,
      0.007385279,
      0.036050577,
      0.028026188,
      0.023528742,
      0.03190819,
      0.005680984,
      0.03148212,
      -0.00948606,
      -0.026156196,
      -0.021717928,
      -0.044003956,
      0.066940926,
      -0.015812071,
      -0.017279658,
      0.03858335,
      0.041281816,
      0.017232317,
      0.048312034,
      -0.002668879,
      -0.018143643,
      0.04563724,
      -0.035198428,
      0.0450218,
      -0.010793869,
      -0.02178894,
      0.046868116,
      0.024108676,
      0.016238146,
      -0.048951145,
      -0.04755457,
      -0.02847593,
      0.015208467,
      0.059460964,
      0.03058263,
      -0.036902726,
      0.0104506435,
      0.034393623,
      -0.025824806,
      0.015965931,
      0.029233396,
      0.0058289263,
      -0.027434418,
      0.017327001,
      0.0057224077,
      -0.014155118,
      -0.00479333,
      0.0052549103,
      -0.0066218968,
      -0.02181261,
      -0.0050596264,
      -0.018179148,
      0.038180947,
      0.01266386,
      0.007077559,
      -0.029162385,
      -0.030322252,
      -0.006195823,
      -0.017398013,
      -0.011758453,
      0.011302791,
      0.041920926,
      0.050466076,
      -0.04296244,
      -0.033257425,
      0.0013640278,
      0.015184796,
      -0.08564083,
      0.009645837,
      -0.02530405,
      0.0057460787,
      0.0050211614,
      -0.041021436,
      -0.015551694,
      0.024522914,
      0.013847399,
      0.045305848,
      -0.026416576,
      -0.052407075,
      -0.00063282315,
      0.015303151,
      0.03268933,
      0.023658931,
      -0.035435136,
      -0.026771637,
      -0.0148415705,
      0.0071189827,
      0.010675516,
      0.055247568,
      0.014616698,
      0.0050182026,
      -0.023777286,
      -0.039388154,
      -0.016297322,
      0.03706842,
      0.012900568,
      0.019670406,
      -0.031647816,
      -0.04357788,
      0.024806963,
      -0.02781315,
      -0.02145755,
      0.0009830765,
      0.015717389,
      -0.052312393,
      -0.010107418,
      0.010918141,
      0.0034973556,
      -0.05316454,
      -0.017327001,
      0.022215014,
      0.02781315,
      0.0072195837,
      -0.028381249,
      0.0007700396,
      0.041163463,
      0.06978142,
      0.0155398585,
      -0.0043435856,
      -0.02845226,
      -0.0025238954,
      0.030203898,
      0.02930441,
      -0.048122667,
      0.035032734,
      0.03212123,
      0.030061873,
      -0.010426973,
      0.035411466,
      0.033778183,
      0.0061484817,
      -0.017954277,
      -0.041329157,
      0.0332811,
      0.0020371652,
      -0.00505075,
      -0.004026989,
      -0.01945737,
      -0.027884163,
      0.011296873,
      0.012486329,
      0.04504547,
      0.020416036,
      0.029115042,
      0.020285847,
      -0.0035210266,
      -0.06907129,
      0.026132526,
      0.0047223177,
      -0.010350043,
      0.017551873,
      -0.016463017,
      -0.0388674,
      -0.008456381,
      -0.008361698,
      0.023221022,
      0.019220661,
      0.0012841391,
      0.027718468,
      0.019978127,
      0.018214654,
      0.03917512,
      -0.013882904,
      -0.01978876,
      0.017267823,
      -0.0030742409,
      0.034464635,
      -0.008006637,
      0.026037842,
      0.004911684,
      0.0020963422,
      -0.035127416,
      -0.0023522824,
      0.0450218,
      -0.014249802,
      -0.021907294,
      -0.03777854,
      0.018522374,
      -0.019516546,
      -0.0077817645,
      0.0041483017,
      -0.027884163,
      0.0010577873,
      -0.04416965,
      -0.04042967,
      -0.005544877,
      -0.023753613,
      0.012770378,
      -0.040903084,
      -0.008947549,
      -0.03119807,
      0.042844087,
      0.027410747,
      0.005314087,
      -0.0082788505,
      -0.004740071,
      -0.0025194571,
      0.014829735,
      0.0014993951,
      -0.011995161,
      -0.021410208,
      -0.000018804853,
      -0.004831795,
      -0.031434778,
      -0.013208288,
      0.020806603,
      0.0056898603,
      0.025398733,
      0.018202819,
      -0.028026188,
      0.039411824,
      0.0139894225,
      -0.01253367,
      -0.007811353,
      0.022641089,
      0.018747248,
      0.008438628,
      0.02130369,
      0.016143462,
      -0.0036097919,
      0.04050068,
      0.034748685,
      -0.0016687891,
      -0.008420875,
      -0.018167313,
      0.002012015,
      0.02240438,
      0.0058437204,
      -0.031056045,
      -0.028641628,
      0.016865421,
      0.019694077,
      -0.016723396,
      -0.048075326,
      -0.054016687,
      0.03129275,
      -0.0041127955,
      -0.011184437,
      -0.04606331,
      -0.009941722,
      -0.06651485,
      -0.0075746453,
      0.03330477,
      -0.013918411,
      -0.007752176,
      -0.02148122,
      0.025753794,
      -0.022061154,
      -0.020167492,
      -0.027505431,
      -0.0377312,
      0.023576083,
      -0.047933303,
      0.000048543563,
      -0.01914965,
      -0.03058263,
      -0.029612128,
      0.012450823,
      -0.02596683,
      0.025469745,
      -0.03183718,
      -0.018581552,
      -0.014557521,
      -0.007367526,
      -0.004677935,
      0.030464277,
      0.010273113,
      -0.059176914,
      -0.029777825,
      -0.010196183,
      -0.008296603,
      0.020392366,
      0.045897614,
      0.02532772,
      -0.02286596,
      -0.017445356,
      -0.0014764641,
      0.013871069,
      0.011503993,
      0.010290866,
      0.020131987,
      0.018699905,
      0.0014897789,
      -0.048998486,
      -0.024641268,
      -0.016924597,
      0.0011354571,
      0.019256169,
      0.021682423,
      -0.007734423,
      -0.029470105,
      -0.038488667,
      0.003722228,
      0.004846589,
      -0.014036764,
      -0.009693178,
      0.015989603,
      0.005544877,
      0.034843367,
      -0.012403482,
      0.015125619,
      0.036595006,
      -0.0039145527,
      0.035458807,
      0.020451542,
      -0.006201741,
      0.015243974,
      0.0015415587,
      0.021339197,
      0.014178789,
      -0.006829016,
      0.049945317,
      0.011498075,
      -0.040619034,
      0.004393886,
      -0.027363406,
      0.021197172,
      -0.022570075,
      0.009616249,
      0.0155871995,
      -0.007136736,
      0.016806245,
      0.018119972,
      -0.0022694347,
      -0.013137275,
      -0.004195643,
      0.04012195,
      0.020475212,
      0.02301982,
      -0.01110159,
      -0.004603964,
      -0.014936253,
      -0.00008428087,
      0.01453385,
      0.0037695696,
      0.009533402,
      0.035553493,
      0.016060615,
      -0.049377218,
      -0.026487587,
      -0.004935355,
      0.0022620377,
      0.008568818,
      -0.031671487,
      0.004275532,
      -0.010568997,
      0.015243974,
      0.01112526,
      0.0064384486,
      0.014711381,
      -0.017019281,
      -0.0030076667,
      0.004568458,
      -0.00648579,
      0.03183718,
      -0.0321449,
      -0.014320814,
      0.058561474,
      -0.030535288,
      -0.020782933,
      -0.053022515,
      -0.031079717,
      -0.051412903,
      -0.008669418,
      0.0005414688,
      -0.004183808,
      0.003355331,
      -0.009184257,
      -0.019836102,
      0.0018640729,
      -0.012119432,
      -0.03205022,
      0.018853765,
      -0.028902005,
      -0.010983235,
      -0.042560037,
      0.019054966,
      0.0025815929,
      -0.036950067,
      0.01117852,
      0.005506412,
      -0.020155657,
      0.0067461682,
      -0.05770933,
      -0.008793689,
      0.027292393,
      0.00802439,
      0.022061154,
      0.036074247,
      0.026747966,
      -0.018640729,
      -0.0061425637,
      -0.020297682,
      -0.02191913,
      -0.026629612,
      -0.043175478,
      -0.014948089,
      0.014214295,
      -0.047980644,
      0.005775667,
      -0.025706451,
      -0.024061333,
      0.0060715517,
      -0.02563544,
      -0.029919848,
      0.0321449,
      -0.008645748,
      0.008077649,
      -0.0020164533,
      0.00054109894,
      0.018190984,
      -0.047601912,
      -0.011545416,
      0.04450104,
      0.026321892,
      -0.017942442,
      -0.010598586,
      0.01407227,
      -0.0024440065,
      0.014782393,
      -0.006775757,
      -0.0118472185,
      -0.025114683,
      -0.009207928,
      0.018877435,
      0.011823548,
      0.042252317,
      0.011308708,
      0.010302701,
      0.0016643507,
      0.005621807,
      0.017634721,
      -0.01594226,
      0.01681808,
      -0.04532952,
      -0.007959295,
      0.054111373,
      0.0021806695,
      0.025777465,
      0.012628354,
      -0.020084646,
      -0.03089035,
      0.015196632,
      0.017386178,
      0.018830094,
      0.017693898,
      0.013066263,
      -0.04140017,
      0.01994262,
      0.00502412,
      0.0055389595,
      -0.020652743,
      -0.013113605,
      -0.03122174,
      0.03266566,
      0.010941812,
      0.03361249,
      0.0030047079,
      0.004624676,
      0.0029869548,
      0.0332811,
      0.01563454,
      -0.044927113,
      0.010077829,
      -0.02996719,
      -0.00133296,
      0.0011798397,
      -0.012249622,
      -0.006432531,
      0.042062953,
      0.036689688,
      -0.00994764,
      -0.055389594,
      0.0017028158,
      0.0115217455,
      0.0014010135,
      0.019705912,
      -0.00463947,
      -0.000029680921,
      -0.00067942496,
      -0.0058259675,
      -0.008385369,
      0.033801854,
      0.013811892,
      -0.018676234,
      -0.008675336,
      -0.023753613,
      0.014746888,
      0.040642705,
      -0.016415676,
      0.019244334,
      0.018546045,
      -0.026771637,
      -0.015350492,
      -0.008373533,
      0.028310236,
      0.0058407616,
      -0.013871069,
      0.017622886,
      -0.018486869,
      0.015208467,
      0.01971775,
      0.007266925,
      0.00833211,
      -0.06054982,
      0.0129952505,
      -0.016877256,
      0.0088055255,
      -0.07063357,
      0.023090832,
      0.021102488,
      -0.020131987,
      0.057330597,
      -0.010054158,
      -0.024333548,
      -0.017054787,
      -0.000046925445,
      0.02317368,
      -0.0039263885,
      0.00797113,
      -0.021694258,
      0.03981423,
      0.007823188,
      0.0005096612,
      0.009059986,
      0.034961723,
      -0.016924597,
      0.02840492,
      0.016261816,
      -0.027529102,
      -0.01143298,
      0.005873309,
      0.003935265,
      0.052359734,
      0.0081072375,
      0.008651665,
      0.00374294,
      0.031955533,
      0.011776206,
      0.0016613919,
      -0.035103746,
      -0.015220303,
      -0.028310236,
      0.053969346,
      0.046820775,
      0.005627725,
      0.02440456,
      -0.0062254113,
      0.017433519,
      -0.012758543,
      -0.0026910703,
      0.017090293,
      0.024688609,
      0.055152886,
      -0.0055389595,
      0.01919699,
      -0.012012914,
      -0.033588815,
      0.0048051653,
      0.008432711,
      -0.03458299,
      0.023812791,
      0.050513417,
      -0.0056366012,
      0.0034500142,
      0.039009422,
      0.007556892,
      -0.00748588,
      0.001184278,
      -0.009622167,
      0.037825886,
      0.0075450568,
      -0.015255809,
      0.008580653,
      0.0039678123,
      -0.011681523,
      -0.02568278,
      0.0010629654,
      0.0022206136,
      -0.014439167,
      0.015101949,
      -0.02899669,
      -0.015409669,
      0.017031116,
      0.061354626,
      -0.002340447,
      0.014794229,
      0.008515558,
      -0.028854664,
      0.059745014,
      0.059129573,
      -0.013800057,
      -0.0029544076,
      0.009776026,
      -0.010711022,
      0.004092084,
      0.011634181,
      0.012042502,
      -0.012285127,
      0.0071308184,
      0.023871968,
      0.009089574,
      0.017540038,
      -0.007479962,
      0.012249622,
      -0.036642347,
      -0.00026796048,
      -0.02591949,
      -0.020629073,
      0.033801854,
      0.017078457,
      0.007189995,
      -0.05041873,
      0.026156196,
      -0.002122972,
      -0.0035594914,
      0.00266592,
      -0.016711561,
      -0.025398733,
      -0.029919848,
      0.026700625,
      0.05808806,
      -0.0029203808,
      -0.010787952,
      0.044927113,
      -0.011870889,
      -0.0036600921,
      0.0013862193,
      0.005311128,
      -0.008858784,
      0.00003855746,
      0.012711202,
      -0.022605581,
      0.010983235,
      0.03796791,
      0.014758723,
      0.03249996,
      0.056762498,
      0.065662704,
      0.0071485713,
      -0.030487947,
      0.004911684,
      0.019220661,
      0.028523274,
      -0.006811263,
      -0.026700625,
      0.012959745,
      -0.003683763,
      -0.00081294286,
      -0.042536367,
      -0.030085543,
      0.03825196,
      0.036263615,
      0.05652579,
      0.009438718,
      0.022593746,
      -0.05075012,
      -0.024570255,
      0.044974457,
      0.026487587,
      -0.017528202,
      0.003778446,
      0.0315768,
      0.0342516,
      -0.024806963,
      0.023244692,
      -0.013160946,
      -0.013930246,
      0.0097050145,
      -0.039364483,
      0.030369593,
      -0.009906216,
      -0.013480501,
      -0.001497176,
      0.031150728,
      0.01888927,
      -0.0016377211,
      -0.00817825,
      0.0033257427,
      0.020368695,
      0.010178429,
      0.0030446523,
      0.018285668,
      -0.009941722,
      0.0062609175,
      0.02345773,
      0.00974052,
      -0.009077739,
      -0.02563544,
      0.00787053,
      -0.041021436,
      0.038725372,
      -0.0321449,
      -0.07243255,
      0.006420695,
      0.02530405,
      0.006811263,
      -0.008864702,
      -0.027292393,
      -0.016652385,
      -0.03247629,
      -0.006056757,
      0.0051276796,
      0.010912223,
      -0.0062609175,
      0.015977766,
      -0.00018640728,
      -0.0018551963,
      -0.018001618,
      -0.0043317503,
      0.033517804,
      -0.039388154,
      0.007805435,
      0.0018907024,
      -0.022925137,
      -0.02268843,
      0.0029129838,
      0.015847579,
      0.041139793,
      0.014983595,
      0.035198428,
      0.014368155,
      -0.0013196452,
      -0.0048406716,
      0.029777825,
      -0.027907833,
      0.0059236092,
      0.029138714,
      0.039009422,
      0.00085806526,
      -0.006450284,
      -0.019362686,
      -0.048288364,
      0.022167673,
      -0.0074326205,
      0.008710842,
      -0.026345562,
      0.06481056,
      -0.0077225873,
      -0.028973019,
      -0.024664938,
      -0.007515468,
      -0.001707254,
      -0.044974457,
      -0.004953108,
      -0.014131447,
      -0.006965123,
      -0.0010548285,
      0.0006468777,
      0.0019987004,
      0.018640729,
      -0.017184976,
      0.003302072,
      -0.0043435856,
      -0.0122969635,
      0.0112732025,
      0.0069532874,
      0.00043125177,
      0.005914733,
      -0.006213576,
      0.0004693469,
      -0.02847593,
      -0.003568368,
      -0.0019469205,
      -0.008687171,
      0.032310598,
      0.04042967,
      0.017007446,
      -0.014652205,
      -0.0021348072,
      0.042583708,
      0.015279479,
      0.017634721,
      0.035884883,
      -0.011143013,
      0.0024395683,
      0.0079060355,
      0.011959654,
      0.0015371204,
      0.020108316,
      0.005337758,
      -0.0067461682,
      -0.027907833,
      0.022321533,
      -0.011533581,
      0.00671658,
      -0.022605581,
      -0.00997131,
      -0.047933303,
      -0.0051158443,
      0.032547303,
      -0.01956389,
      0.00148682,
      0.004092084,
      -0.060644504,
      0.04050068,
      0.011119342,
      -0.0043199146,
      0.016309159,
      -0.004456022,
      -0.026345562,
      -0.03332844,
      -0.01714947,
      0.046820775,
      0.01253367,
      0.011569087,
      0.0047903713,
      0.024972659,
      -0.006580473,
      0.008468216,
      -0.022084825,
      0.0342516,
      0.06731966,
      0.023374882,
      0.053922005,
      -0.019646736,
      -0.042536367,
      0.0019202909,
      -0.0122969635,
      0.039080434,
      -0.016723396,
      0.024759622,
      -0.009929886,
      -0.0336835,
      -0.008284768,
      0.03986157,
      -0.028570615,
      0.0017619927,
      -0.010373713,
      0.004532952,
      -0.00794746,
      0.022475393,
      0.0056099715,
      0.015232138,
      -0.022309696,
      0.015705554,
      -0.00948606,
      0.05965033,
      -0.025517086,
      -0.021209007,
      -0.026061514,
      0.041849915,
      0.0006073031,
      -0.0051927743,
      0.010722857,
      0.0015104908,
      0.0046897708,
      -0.0011805794,
      0.032002877,
      0.003985565,
      -0.034843367,
      -0.014143283,
      0.004926478,
      -0.0004142384,
      0.05093949,
      -0.00010291235,
      -0.0003876088,
      0.005068503,
      -0.03955385,
      0.029115042,
      -0.014166954,
      -0.047081154,
      -0.010669598,
      -0.014462838,
      -0.018759083,
      -0.026369235,
      0.020439707,
      -0.0055951774,
      0.013859234,
      -0.004571417,
      -0.007136736,
      0.012024749,
      0.006278671,
      0.020806603,
      0.017054787,
      0.00997131,
      -0.042252317,
      0.031340096,
      0.03917512,
      -0.017599214,
      0.008545146,
      0.0015992562,
      -0.024002157,
      -0.0014742449,
      0.020487048,
      -0.0110720005,
      0.012604683,
      0.005355511,
      0.03775487,
      -0.02842859,
      -0.0074681267,
      -0.0008491887,
      0.01268753,
      0.0049560666,
      0.021753434,
      0.04532952,
      -0.0028049857,
      -0.015101949,
      0.0025727164,
      0.019824266,
      -0.0336835,
      -0.014853406,
      0.003334619,
      0.016297322,
      0.008710842,
      -0.06561536,
      -0.01904313,
      -0.0049560666,
      -0.0047519063,
      0.02471228,
      0.012936073,
      0.00032824694,
      -0.012379811,
      -0.01822649,
      -0.020984134,
      0.03394388,
      -0.023161845,
      0.011864971,
      -0.020735592,
      -0.015883084,
      0.034535646,
      -0.0077166697,
      -0.004701606,
      -0.020984134,
      -0.01917332,
      0.01453385,
      -0.000011373064,
      -0.008870619,
      -0.0031097468,
      -0.0022058196,
      0.02622721,
      -0.0016687891,
      -0.00090540684,
      0.003997401,
      -0.011083837,
      0.006829016,
      -0.0296358,
      0.000815162,
      -0.012332469,
      -0.0014165475,
      0.003009146,
      -0.0027413706,
      -0.013776386,
      -0.022345204,
      0.013871069,
      -0.014924418,
      -0.0037814048,
      0.012178609,
      0.04260738,
      0.00061617966,
      0.0051483917,
      -0.008296603,
      -0.007616069,
      -0.019386357,
      -0.0004604704,
      -0.007959295,
      0.0067935097,
      0.04360155,
      0.018427692,
      0.021339197,
      -0.0024454861,
      0.023197351,
      0.0066278144,
      -0.032239582,
      -0.007835024,
      -0.0004745249,
      0.0018448404,
      -0.03297338,
      0.00004130826,
      -0.008598406,
      -0.0045921286,
      -0.014439167,
      -0.03957752,
      0.044690408,
      0.00044308716,
      -0.0064739548,
      -0.032002877,
      -0.008071731,
      -0.009030397,
      -0.007367526,
      0.029280737,
      -0.012450823,
      -0.0067224978,
      -0.009397294,
      0.032263253,
      -0.028262895,
      0.024025828,
      0.0038346641,
      -0.014983595,
      -0.0011066083,
      -0.014391826,
      0.043175478,
      -0.015812071,
      0.00328136,
      0.010480232,
      0.0060390043,
      -0.034038562,
      0.027529102,
      0.027552772,
      0.022084825,
      0.005846679,
      -0.0014387388,
      -0.030748324,
      -0.015267644,
      -0.019031296,
      -0.009728685,
      0.020664578,
      0.028546944,
      -0.031671487,
      0.010634092,
      0.014877076,
      -0.004991573,
      0.0062964237,
      0.041116122,
      -0.0010452123,
      -0.0009697617,
      0.011906396,
      0.05657313,
      0.03276034,
      -0.0031304588,
      0.0076397397,
      0.010332289,
      0.005488659,
      -0.0043820506,
      -0.035553493,
      0.0035920388,
      -0.05685718,
      -0.005003408,
      -0.03306806,
      0.0469628,
      0.01714947,
      0.010912223,
      -0.012592847,
      0.0046838527,
      0.01253367,
      0.03238161,
      -0.0015933384,
      0.021670587,
      -0.0011953737,
      -0.005467947,
      0.022700265,
      0.004393886,
      -0.014285307,
      -0.0027842738,
      -0.030914022,
      -0.025493415,
      -0.014084106,
      0.016119791,
      -0.030038202,
      0.018037124,
      -0.018569715,
      0.0077403407,
      0.011450733,
      -0.044359017,
      0.0063378476,
      0.004544787,
      -0.030937692,
      0.0049974904,
      0.00073712243,
      -0.00035358206,
      0.0039145527,
      -0.0039766887,
      -0.03953018,
      0.00633193,
      0.037518166,
      0.037494496,
      -0.023540577,
      -0.0023759531,
      0.00710123,
      -0.014332649,
      0.018001618,
      -0.022877796,
      0.01838035,
      -0.01150991,
      -0.0042873677,
      -0.009965393,
      0.0027783562,
      -0.047057483,
      0.008136826,
      0.0026614817,
      -0.007006547,
      0.009574825,
      -0.026889991,
      -0.0056070127,
      0.021398373,
      -0.044927113,
      -0.048572414,
      -0.0010533491,
      0.035695516,
      -0.045921285,
      0.006136646,
      0.00018936612,
      -0.01563454,
      0.021137994,
      0.024357218,
      -0.019540217,
      -0.011527663,
      0.047767606,
      0.013078098,
      -0.031955533,
      -0.018048959,
      -0.047696594,
      0.010557162,
      0.013208288,
      -0.0067402506,
      -0.015409669,
      -0.010196183,
      0.017327001,
      0.02502,
      0.015326821,
      0.03209756,
      0.0061425637,
      0.020285847,
      0.032239582,
      0.018948449,
      -0.018001618,
      -0.024854304,
      0.013267465,
      -0.015622706,
      -0.01133238,
      -0.012711202,
      -0.009491977,
      0.0055922186,
      0.012474494,
      0.021433879,
      0.01868807,
      -0.012427152,
      -0.022155838,
      -0.011734783,
      0.008450463,
      0.0026703584,
      0.0082788505,
      0.012853226,
      0.03186085,
      0.034796026,
      -0.03616893,
      0.032926034,
      -0.032878693,
      0.028830994,
      -0.018924778,
      0.075131014,
      0.035293113,
      -0.03238161,
      0.008184168,
      0.0015008745,
      0.020593567,
      0.002053439,
      0.03552982,
      0.018936614,
      -0.02238071,
      0.010716939,
      -0.041731562,
      -0.0129952505,
      0.023434058,
      0.0021288896,
      -0.047199506,
      -0.009367705,
      0.047175836,
      0.0013129878,
      0.015184796,
      0.030771997,
      0.007367526,
      -0.030795667,
      -0.012178609,
      0.020238506,
      0.020356858,
      -0.018498704,
      0.0040181126,
      -0.016119791,
      0.006278671,
      -0.0120484205,
      -0.03976689,
      0.017658392,
      -0.02297248,
      0.007521386,
      -0.0007737382,
      -0.029162385,
      0.002850848,
      0.0016318035,
      -0.034725014,
      0.006278671,
      -0.003260648,
      0.027623784,
      -0.021078818,
      -0.023647096,
      -0.03863069,
      -0.005201651,
      0.047909632,
      0.02130369,
      -0.012143103,
      -0.017315166,
      -0.0025756753
    ]; // replace with your query vector
    const collectionName = "catalog";
    const collection = client.db("ecommerce").collection(collectionName);
    const pipeline = [
      {
        $vectorSearch: {
          index: "vector_index", 
          //path: "vector", 
          path: "description_embedding", 
          queryVector:queryVector, 
          numCandidates: 3, 
          limit: 2
        }
      }, {
        '$project': {
          _id: 0, 
          title: 1, 
          description: 1, 
          score: {
            $meta: "vectorSearchScore"
          }
        }
      }
    ];

    const result = await collection.aggregate(pipeline).toArray();

    res.json(result);

  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});


app.get('/vectorize', async (req, res) => {
  const collectionName = "catalog";
  const collection = client.db("ecommerce").collection(collectionName);

  const cursor = collection.find({});
  while (await cursor.hasNext()) {
      const doc = await cursor.next();
      const vector = await createVector(doc.description); // replace with your field
      await collection.updateOne({ _id: doc._id }, { $set: { description_embedding: vector } });
  }

  res.send('Vectorization completed');
});

async function createVector(data) {
  const response = await openai.embeddings.create({
      model: "text-embedding-3-small",
      input: data,
      encoding_format: "float"
  });

  return response.data[0].embedding;
}

//TODO: busqueda abuelita
//TODO: image search
app.get('/image-search', async (req, res) => {
  const vector = req.query.q;
  try {
    const queryVector = [
      6.172224044799805,
        3.2100844383239746,
        3.439617872238159,
        2.5651497840881348,
        5.7227301597595215,
        9.031953811645508,
        6.419071674346924,
        2.648453712463379,
        2.249253511428833,
        4.398337364196777,
        4.146055221557617,
        3.8159587383270264,
        5.053159236907959,
        3.558739185333252,
        3.2666406631469727,
        4.8439130783081055,
        5.287764072418213,
        3.57478928565979,
        5.080653190612793,
        4.582855224609375,
        1.869140625,
        5.818809509277344,
        4.203996181488037,
        3.047271251678467,
        4.410797595977783,
        3.7212536334991455,
        6.663562774658203,
        7.118425369262695,
        7.477076053619385,
        2.849001169204712,
        3.4656455516815186,
        5.682618141174316,
        5.7739129066467285,
        3.14311146736145,
        6.190525054931641,
        4.874553203582764,
        5.54624605178833,
        4.509696960449219,
        7.289438724517822,
        5.113977432250977,
        5.454272270202637,
        4.8176350593566895,
        2.838801860809326,
        6.309726238250732,
        4.742313861846924,
        4.839508533477783,
        6.112161636352539,
        4.252041339874268,
        1.866045355796814,
        3.035318374633789,
        5.558555603027344,
        7.512358665466309,
        8.001433372497559,
        7.866710662841797,
        5.824526309967041,
        4.288651466369629,
        8.182363510131836,
        5.383183479309082,
        3.5577573776245117,
        6.74879789352417,
        8.672553062438965,
        6.0985107421875,
        4.330440998077393,
        8.351428031921387,
        5.073493003845215,
        6.052791595458984,
        6.48205041885376,
        6.385249614715576,
        5.697512626647949,
        11.193991661071777,
        8.675581932067871,
        10.271927833557129,
        8.008573532104492,
        8.590838432312012,
        6.275906562805176,
        9.137968063354492,
        6.417513847351074,
        6.377136707305908,
        7.655421733856201,
        8.279376029968262,
        3.3944594860076904,
        2.6359715461730957,
        4.320236682891846,
        5.092044830322266,
        2.3709757328033447,
        3.761303424835205,
        2.3374102115631104,
        5.686277866363525,
        6.496348857879639,
        5.923151016235352,
        3.8305437564849854,
        5.7745232582092285,
        6.3012776374816895,
        7.2018890380859375,
        7.776715278625488,
        3.960944652557373,
        8.711433410644531,
        3.6862435340881348,
        2.2371582984924316,
        5.395439624786377,
        5.661983966827393,
        5.7678070068359375,
        2.2447447776794434,
        4.716520309448242,
        4.25265645980835,
        5.499902725219727,
        6.284363746643066,
        5.027911186218262,
        5.125764846801758,
        2.888500452041626,
        8.297378540039062,
        10.534225463867188,
        9.341499328613281,
        5.496992588043213,
        5.023690700531006,
        4.0093913078308105,
        7.750926494598389,
        6.99274206161499,
        10.92203426361084,
        6.9929423332214355,
        7.7794508934021,
        10.683243751525879,
        12.195728302001953,
        9.5639066696167,
        7.510576248168945,
        5.480984210968018,
        10.06916332244873,
        4.45701789855957,
        5.014733791351318,
        6.735498428344727,
        4.424798011779785,
        2.3919222354888916,
        4.084188938140869,
        2.032841682434082,
        3.521027088165283,
        4.448049068450928,
        1.8586145639419556,
        3.0405125617980957,
        2.075655460357666,
        1.1773388385772705,
        2.2826426029205322,
        1.8615003824234009,
        1.558199167251587,
        2.4528567790985107,
        6.952038764953613,
        7.225629806518555,
        6.161796569824219,
        5.402259349822998,
        4.8335394859313965,
        3.3217275142669678,
        4.970635414123535,
        8.943343162536621,
        6.724090576171875,
        9.113685607910156,
        7.914615631103516,
        9.572284698486328,
        5.860214710235596,
        6.374608516693115,
        7.391673564910889,
        8.329270362854004,
        8.888416290283203,
        9.858936309814453,
        7.8263258934021,
        8.832648277282715,
        6.175848960876465,
        8.864625930786133,
        6.282773494720459,
        6.716906547546387,
        9.398740768432617,
        7.9013352394104,
        8.939080238342285,
        7.513735294342041,
        6.414669990539551,
        8.05152416229248,
        8.95559310913086,
        7.650625228881836,
        7.26635217666626,
        8.905911445617676,
        7.789644718170166,
        7.9733662605285645,
        6.90198278427124,
        7.318669319152832,
        7.786427021026611,
        10.982390403747559,
        9.500686645507812,
        9.692441940307617,
        8.223836898803711,
        10.133061408996582,
        9.4594144821167,
        11.301448822021484,
        10.121098518371582,
        9.917978286743164,
        6.863307476043701,
        7.9514875411987305,
        8.917364120483398,
        11.395998001098633,
        8.54829216003418,
        9.851036071777344,
        9.223836898803711,
        9.08540153503418,
        6.691222190856934,
        7.163631916046143,
        8.98401927947998,
        9.292521476745605,
        8.850688934326172,
        6.396711349487305,
        7.453142166137695,
        5.94624137878418,
        8.256593704223633,
        6.850630760192871,
        6.769379615783691,
        7.33479118347168,
        5.639683246612549,
        5.7261247634887695,
        8.33230972290039,
        6.443534851074219,
        8.238967895507812,
        6.640289306640625,
        4.7759270668029785,
        7.765411853790283,
        8.552352905273438,
        9.890727996826172,
        6.486650466918945,
        10.092489242553711,
        6.580765724182129,
        9.757826805114746,
        8.662636756896973,
        5.758419990539551,
        6.877425670623779,
        8.769085884094238,
        6.293385028839111,
        5.8248395919799805,
        5.756032466888428,
        12.072175025939941,
        8.289702415466309,
        7.693736553192139,
        8.239429473876953,
        9.368894577026367,
        7.981964111328125,
        7.878513336181641,
        7.30234956741333,
        5.795854568481445,
        7.449783802032471,
        7.396514892578125,
        3.893165349960327,
        9.305350303649902,
        7.522328853607178,
        6.858138561248779,
        7.064510822296143,
        8.042430877685547,
        6.983739376068115,
        7.441043853759766,
        9.671408653259277,
        8.462285041809082,
        9.700159072875977,
        6.153591156005859,
        8.604350090026855,
        7.498345375061035,
        9.829268455505371,
        8.766093254089355,
        8.238753318786621,
        12.017855644226074,
        8.714364051818848,
        9.0485200881958,
        8.065530776977539,
        7.03352165222168,
        6.529731750488281,
        6.0472941398620605,
        6.939450263977051,
        3.1869423389434814,
        4.5291571617126465,
        5.755915641784668,
        2.4636716842651367,
        3.8560287952423096,
        2.9583117961883545,
        1.6811593770980835,
        1.3733235597610474,
        4.011579990386963,
        1.4546079635620117,
        5.457650661468506,
        2.953211784362793,
        9.24207878112793,
        7.331459045410156,
        9.1316556930542,
        8.186094284057617,
        7.480778694152832,
        4.635963439941406,
        3.7983291149139404,
        3.1035282611846924,
        2.86834979057312,
        1.549572229385376,
        3.622819423675537,
        5.353736877441406,
        5.226619243621826,
        1.3214646577835083,
        2.5485970973968506,
        2.9600846767425537,
        2.0980687141418457,
        4.6735968589782715,
        6.245235443115234,
        8.60163402557373,
        5.631896018981934,
        7.97943639755249,
        12.011491775512695,
        7.107598304748535,
        5.9923882484436035,
        10.14302921295166,
        7.6753129959106445,
        8.340643882751465,
        4.932838439941406,
        8.735196113586426,
        7.9783124923706055,
        8.542847633361816,
        10.71104621887207,
        9.977948188781738,
        9.98599624633789,
        6.039805889129639,
        7.8240885734558105,
        6.002385139465332,
        7.790071487426758,
        7.673004627227783,
        5.638312339782715,
        4.792781829833984,
        6.432969570159912,
        4.330610275268555,
        5.188277721405029,
        5.998973369598389,
        4.407073974609375,
        5.570603370666504,
        4.777514457702637,
        7.3839335441589355,
        6.204967021942139,
        8.933036804199219,
        10.158468246459961,
        6.151413440704346,
        5.179557800292969,
        2.9373779296875,
        4.01866340637207,
        7.794694900512695,
        7.365880012512207,
        4.18337869644165,
        5.848536968231201,
        2.3151071071624756,
        4.8046345710754395,
        2.6310670375823975,
        5.606212615966797,
        3.9529755115509033,
        4.640967845916748,
        4.4024577140808105,
        3.2657034397125244,
        5.723935604095459,
        5.778053283691406,
        5.918861389160156,
        6.860786437988281,
        9.171753883361816,
        5.7328267097473145,
        8.570808410644531,
        4.606438636779785,
        7.844161033630371,
        10.29032039642334,
        2.7658798694610596,
        8.63787841796875,
        6.659023761749268,
        5.166305065155029,
        7.07036828994751,
        5.367495059967041,
        2.1284658908843994,
        6.117594242095947,
        5.262639045715332,
        4.527763366699219,
        4.673402786254883,
        5.751450538635254,
        3.319239616394043,
        3.5450973510742188,
        4.274157524108887,
        3.7356903553009033,
        2.8770978450775146,
        4.799208164215088,
        4.414614677429199,
        3.0419187545776367,
        3.8429784774780273,
        4.393747329711914,
        4.665245056152344,
        4.407656192779541,
        3.1910300254821777,
        5.818783283233643,
        5.58943510055542,
        2.798429489135742,
        2.0248289108276367,
        6.450109958648682,
        4.256872653961182,
        8.792397499084473,
        5.433084964752197,
        6.11116361618042,
        8.361128807067871,
        7.189366340637207,
        2.4071831703186035,
        2.34399151802063,
        8.72710132598877,
        14.170954704284668,
        12.135964393615723,
        12.390405654907227,
        13.406346321105957,
        3.503999710083008,
        6.8271355628967285,
        7.732224464416504,
        6.93117094039917,
        6.4161176681518555,
        9.947633743286133,
        13.247157096862793,
        5.576175212860107,
        18.362865447998047,
        13.162434577941895,
        12.570491790771484,
        25.156728744506836,
        9.242349624633789,
        11.25472354888916,
        11.556840896606445,
        12.974137306213379,
        15.420684814453125,
        10.896596908569336,
        9.932778358459473,
        12.472085952758789,
        17.457101821899414,
        12.08333969116211,
        5.794112682342529,
        10.189249038696289,
        15.58530330657959,
        12.899759292602539,
        8.605320930480957,
        13.298670768737793,
        17.71643829345703,
        11.703201293945312,
        13.744370460510254,
        17.128963470458984,
        12.226414680480957,
        9.561308860778809,
        11.972185134887695,
        10.33333969116211,
        15.560257911682129,
        10.91069221496582,
        8.670027732849121,
        10.718888282775879,
        14.267291069030762,
        6.998377799987793,
        13.484224319458008,
        18.111448287963867,
        15.515864372253418,
        11.577622413635254,
        4.294496536254883,
        10.762754440307617,
        15.052471160888672,
        14.142020225524902,
        10.44589614868164,
        5.958807468414307,
        10.10096263885498,
        15.742819786071777,
        14.4191312789917,
        6.937541961669922,
        17.528881072998047,
        5.983590602874756,
        18.05045509338379,
        12.767719268798828,
        15.855457305908203,
        19.62956428527832,
        20.580341339111328,
        5.505791664123535,
        6.435435771942139,
        8.7941312789917,
        12.957401275634766,
        13.295645713806152,
        11.529464721679688,
        9.624969482421875,
        12.816757202148438,
        13.216700553894043,
        8.27027702331543,
        7.39448881149292,
        17.615110397338867,
        15.72706413269043,
        8.992391586303711,
        8.357619285583496,
        13.738384246826172,
        15.922357559204102,
        4.939002513885498,
        8.197813034057617,
        13.254875183105469,
        13.300814628601074,
        14.916284561157227,
        10.64756965637207,
        7.242244720458984,
        16.135940551757812,
        13.59827995300293,
        17.32097816467285,
        12.617378234863281,
        11.473995208740234,
        12.595834732055664,
        9.446972846984863,
        6.065539360046387,
        12.60513687133789,
        13.290369987487793,
        4.518518924713135,
        14.112093925476074,
        19.249298095703125,
        13.778450012207031,
        11.33970832824707,
        13.933391571044922,
        12.980533599853516,
        15.407899856567383,
        9.359602928161621,
        6.845794677734375,
        5.227935791015625,
        11.814352989196777,
        13.389423370361328,
        10.405158042907715,
        19.440061569213867,
        12.766127586364746,
        18.05173110961914,
        9.30223274230957,
        13.353440284729004,
        14.456401824951172,
        12.963314056396484,
        10.393803596496582,
        13.571308135986328,
        13.665375709533691,
        18.69426155090332,
        5.887157917022705,
        13.095703125,
        13.311988830566406,
        17.32575798034668,
        16.275493621826172,
        14.358470916748047,
        16.277050018310547,
        12.533803939819336,
        11.010390281677246,
        9.874924659729004,
        8.872772216796875,
        7.932974815368652,
        7.3375396728515625,
        8.045042991638184,
        11.135306358337402,
        5.379323959350586,
        15.160372734069824,
        10.380514144897461,
        14.491044998168945,
        9.613727569580078,
        14.092633247375488,
        11.30454158782959,
        6.54887056350708,
        10.239659309387207,
        10.497179985046387,
        14.624438285827637,
        13.766463279724121,
        11.219807624816895,
        12.314136505126953,
        6.053940296173096,
        6.401637554168701,
        13.698654174804688,
        10.074130058288574,
        12.102259635925293,
        14.46141242980957,
        12.170089721679688,
        11.838606834411621,
        5.7822585105896,
        11.509923934936523,
        11.009037017822266,
        11.455611228942871,
        8.127565383911133,
        9.590227127075195,
        13.519672393798828,
        7.966283798217773,
        17.881155014038086,
        13.994072914123535,
        9.565140724182129,
        9.830476760864258,
        10.406730651855469,
        9.456422805786133,
        8.096916198730469,
        11.900623321533203,
        14.204109191894531,
        10.402976036071777,
        6.593223571777344,
        7.830032825469971,
        6.478943347930908,
        11.949061393737793,
        12.297370910644531,
        12.732182502746582,
        9.123164176940918,
        12.95742416381836,
        17.183475494384766,
        15.430091857910156,
        14.76978874206543,
        15.4097318649292,
        11.932025909423828,
        14.37705135345459,
        13.321642875671387,
        12.070198059082031,
        14.44715690612793,
        21.00184440612793,
        8.892555236816406,
        10.998074531555176,
        15.399736404418945,
        16.03799819946289,
        10.750311851501465,
        5.944638252258301,
        13.954854011535645,
        12.986621856689453,
        17.79611587524414,
        11.009946823120117,
        14.6814546585083,
        6.069562911987305,
        15.688328742980957,
        10.282068252563477,
        7.540631294250488,
        14.698840141296387,
        14.489630699157715,
        19.2305965423584,
        12.172722816467285,
        15.31850814819336,
        12.82239818572998,
        13.381170272827148,
        13.23646068572998,
        11.603419303894043,
        9.713626861572266,
        13.522830963134766,
        7.66703462600708,
        12.339434623718262,
        14.847650527954102,
        8.466462135314941,
        4.662844181060791,
        13.24637222290039,
        18.63850212097168,
        12.06217098236084,
        14.031668663024902,
        14.755188941955566,
        7.320396900177002,
        16.96588134765625,
        27.701013565063477,
        10.196796417236328,
        16.33452796936035,
        15.755387306213379,
        5.978770732879639,
        12.397697448730469,
        12.000407218933105,
        14.433479309082031,
        10.187901496887207,
        7.1923394203186035,
        9.634845733642578,
        11.769943237304688,
        10.27334213256836,
        7.774041175842285,
        16.323511123657227,
        8.962207794189453,
        12.904597282409668,
        12.382051467895508,
        8.845329284667969,
        17.562326431274414,
        9.141746520996094,
        9.980198860168457,
        11.759241104125977,
        8.728610038757324,
        5.65320348739624,
        7.720440864562988,
        16.79452133178711,
        5.1112380027771,
        12.45418930053711,
        7.560805320739746,
        10.687298774719238,
        13.153778076171875,
        6.327211856842041,
        8.165433883666992,
        9.772055625915527,
        8.441265106201172,
        14.160975456237793,
        14.666831970214844,
        15.44508171081543,
        8.260333061218262,
        18.20981788635254,
        9.555630683898926,
        16.435396194458008,
        14.144574165344238,
        14.288493156433105,
        15.206684112548828,
        8.410955429077148,
        10.73604679107666,
        13.65108585357666,
        4.59060525894165,
        10.986690521240234,
        6.500281810760498,
        13.708869934082031,
        15.613187789916992,
        4.24010705947876,
        16.656278610229492,
        12.666077613830566,
        10.09256649017334,
        5.957728385925293,
        13.504815101623535,
        12.141828536987305,
        13.871376991271973,
        6.084297180175781,
        13.354276657104492,
        15.720726013183594,
        13.796277046203613,
        11.113743782043457,
        8.074383735656738,
        8.553604125976562,
        9.826955795288086,
        7.387024402618408,
        12.681204795837402,
        12.245404243469238,
        16.351699829101562,
        18.940229415893555,
        15.098834037780762,
        9.351856231689453,
        13.225207328796387,
        10.872048377990723,
        12.309012413024902,
        6.290748596191406,
        10.366206169128418,
        3.8952677249908447,
        12.610377311706543,
        12.837416648864746,
        16.50564193725586,
        10.939441680908203,
        7.940422534942627,
        6.94198751449585,
        15.713922500610352,
        12.423504829406738,
        7.219415187835693,
        15.119701385498047,
        12.889541625976562,
        9.57675552368164,
        14.035548210144043,
        17.499671936035156,
        13.117141723632812,
        6.094621658325195,
        14.914498329162598,
        9.481038093566895,
        9.52722454071045,
        14.492658615112305,
        11.5762939453125,
        14.955296516418457,
        9.795230865478516,
        14.99703311920166,
        7.708261966705322,
        11.31305980682373,
        12.065705299377441,
        12.461201667785645,
        16.0074405670166,
        24.25638198852539,
        14.177922248840332,
        11.779288291931152,
        7.787550926208496,
        12.921075820922852,
        11.032336235046387,
        16.80223274230957,
        5.798203945159912,
        12.881546020507812,
        8.546417236328125,
        11.752047538757324,
        15.184805870056152,
        8.379386901855469,
        11.075715065002441,
        7.055130958557129,
        10.709305763244629,
        12.988359451293945,
        17.629995346069336,
        9.55549430847168,
        13.593637466430664,
        9.859576225280762,
        10.452977180480957,
        14.97740650177002,
        9.67333984375,
        12.592663764953613,
        14.002655029296875,
        20.915637969970703,
        16.96697425842285,
        11.528646469116211,
        14.893207550048828,
        14.352802276611328,
        6.89941930770874,
        9.708563804626465,
        7.066507339477539,
        14.24661922454834,
        10.276434898376465,
        13.157964706420898,
        11.167016983032227,
        12.523541450500488,
        14.037022590637207,
        13.055695533752441,
        7.6294426918029785,
        19.777118682861328,
        6.923440933227539,
        15.709842681884766,
        12.835504531860352,
        11.715155601501465,
        10.742790222167969,
        13.222064018249512,
        19.782894134521484,
        11.234246253967285,
        6.602216720581055,
        9.847705841064453,
        15.474566459655762,
        9.926486015319824,
        10.533143997192383,
        14.119348526000977,
        12.562516212463379,
        12.530599594116211,
        9.7245512008667,
        10.802140235900879,
        8.924665451049805,
        12.50423812866211,
        15.244000434875488,
        13.058680534362793,
        12.485795021057129,
        7.819975852966309,
        5.374302387237549,
        11.063701629638672,
        8.827022552490234,
        17.825634002685547,
        10.809907913208008,
        7.147400379180908,
        4.134896278381348,
        11.360922813415527,
        15.787964820861816,
        16.573808670043945,
        4.463174819946289,
        15.147564888000488,
        11.260744094848633,
        12.555464744567871,
        7.886439800262451,
        15.938154220581055,
        18.3043155670166,
        8.196310997009277,
        8.975191116333008,
        16.450597763061523,
        11.314787864685059,
        15.695320129394531,
        14.321037292480469,
        12.392322540283203,
        7.173067569732666,
        16.196821212768555,
        16.441753387451172,
        17.063631057739258,
        14.535490989685059,
        15.436105728149414,
        10.614381790161133,
        13.512162208557129,
        8.491450309753418,
        15.080476760864258,
        12.819771766662598,
        10.624004364013672,
        13.928744316101074,
        12.09485912322998,
        6.723644256591797,
        9.029664993286133,
        12.95283317565918,
        11.34569263458252,
        11.473106384277344,
        14.35757827758789,
        16.882999420166016,
        6.341057300567627,
        12.635354042053223,
        11.877134323120117,
        12.695780754089355,
        8.126256942749023,
        6.795490264892578,
        9.556510925292969,
        8.12451457977295,
        15.321188926696777,
        15.347945213317871,
        10.359126091003418,
        8.57840347290039,
        13.60794734954834,
        4.697286128997803,
        6.13250207901001,
        9.500974655151367,
        13.171917915344238,
        9.084723472595215,
        11.378609657287598,
        11.99018669128418,
        9.022412300109863,
        11.304641723632812,
        18.65289306640625,
        12.27861499786377,
        6.937793254852295,
        17.246965408325195,
        7.3803582191467285,
        13.204423904418945,
        4.5063090324401855,
        12.942926406860352,
        10.363100051879883,
        13.68782901763916,
        13.156340599060059,
        18.872156143188477,
        14.05069637298584,
        9.213706970214844,
        11.68549919128418,
        10.661746978759766,
        14.80760669708252,
        15.160181999206543,
        9.073914527893066,
        10.710033416748047,
        17.78000831604004,
        16.037649154663086,
        8.019806861877441,
        8.70882797241211,
        13.495543479919434,
        9.865168571472168,
        8.506218910217285,
        7.894276142120361,
        8.814647674560547,
        16.869775772094727,
        5.3867387771606445,
        8.37940502166748,
        10.101632118225098,
        9.44283676147461,
        8.0391263961792,
        10.23288631439209,
        8.81083869934082,
        9.544065475463867,
        9.818404197692871,
        11.850861549377441,
        7.17223596572876,
        10.57337760925293,
        9.968802452087402,
        7.616105556488037,
        6.985442638397217,
        6.48926305770874,
        10.317216873168945,
        14.167642593383789,
        12.158994674682617,
        9.228070259094238,
        8.597579956054688,
        8.386418342590332,
        11.716870307922363,
        9.865480422973633,
        10.837079048156738,
        10.212553024291992,
        7.793755531311035,
        7.608584880828857,
        9.468079566955566,
        7.4449968338012695,
        9.114459037780762,
        9.479053497314453,
        8.822327613830566,
        8.738408088684082,
        1.1221098899841309,
        4.3781514167785645,
        10.106203079223633,
        7.911703586578369,
        9.813770294189453,
        7.25239896774292,
        3.718604803085327,
        6.86912202835083,
        9.164713859558105,
        6.149123191833496,
        6.582840919494629,
        5.518882751464844,
        8.291263580322266,
        5.132296085357666,
        13.368314743041992,
        8.79487419128418,
        10.559432029724121,
        7.890254497528076,
        8.370940208435059,
        7.397459506988525,
        10.786185264587402,
        8.726134300231934,
        12.350298881530762,
        11.591475486755371,
        5.221776485443115,
        8.42969799041748,
        6.7232441902160645,
        3.3652799129486084,
        2.0017812252044678,
        5.983249187469482,
        3.3024802207946777,
        8.014122009277344,
        6.567503452301025,
        2.835449457168579,
        2.644979476928711,
        8.432703018188477,
        11.874578475952148,
        8.389764785766602,
        5.653414726257324,
        4.887307167053223,
        2.758563756942749,
        8.327743530273438,
        7.958361625671387,
        4.590335845947266,
        6.17521858215332,
        5.38897180557251,
        4.811102867126465,
        3.943899393081665,
        4.940411567687988,
        3.4381418228149414,
        7.84470272064209,
        4.1462178230285645,
        7.909436225891113,
        15.289725303649902
    ]; // replace with your query vector
    const collectionName = "catalog";
    const collection = client.db("ecommerce").collection(collectionName);
    const pipeline = [
      {
        $vectorSearch: {
          index: "vector_image", 
          //path: "vector", 
          path: "image_embedding", 
          queryVector:queryVector, 
          numCandidates: 3, 
          limit: 2
        }
      }, {
        '$project': {
          _id: 0, 
          title: 1, 
          description: 1, 
          score: {
            $meta: "vectorSearchScore"
          }
        }
      }
    ];

    const result = await collection.aggregate(pipeline).toArray();

    res.json(result);

  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});


const port = process.env.PORT;
console.log(port);

app.listen(port, () => console.log('Server running on port ' + port));

